<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
        crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css'>
</head>
<body>
    <h1>FlowerTest</h1>
    <div id="map" style="width: 100%; height: 1200px;"></div>

    <script type="text/javascript">
        fetch('/static/reports.json')
            .then(response => response.json())
            .then(reports => {
                var coords = [];
                var flower_ids = [];
                var descriptions = [];

                reports.forEach(report => {
                    if (report.maps_query_locations && report.maps_query_locations.length > 0) {
                        report.maps_query_locations.forEach(location => {
                            fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(location)}&key=YOUR_GOOGLE_MAPS_API_KEY`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.results && data.results.length > 0) {
                                        var lat = data.results[0].geometry.location.lat;
                                        var lon = data.results[0].geometry.location.lng;
                                        coords.push([lat, lon]);
                                        flower_ids.push(report.flowers.join(', ') + '\n' + report.date);
                                        descriptions.push(report.original_report);
                                    }
                                });
                        });
                    }
                });

                // Wait for all geocoding requests to complete
                setTimeout(() => {
                    var map = L.map('map').setView([31.771959, 35.217018], 7);
                    var layer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19});
                    map.addLayer(layer);

                    coords.forEach((coord, i) => {
                        var marker = L.marker(coord);
                        marker.description = descriptions[i];
                        marker.title = flower_ids[i];
                        marker.addTo(map);
                        marker.bindPopup('<b>' + flower_ids[i] + '</b><br><a href="#" onclick="showDescription(' + i + ')">Show Description</a>');
                    });

                    function showDescription(index) {
                        alert(descriptions[index]);
                    }
                }, 2000); // Adjust the timeout as needed
            });
    </script>
</body>
</html>
